# Mapbox Styleに関するあれこれ

[Mapbox Style Specification](https://docs.mapbox.com/mapbox-gl-js/style-spec/)に準拠して、地図デザインを行う際のTips、躓いた点、やりたいことなどのメモ

## スタイル表示速度について
Mapboxのトラブルシューティングのページを見ていると、大きなサイズのデータ表示を早くする方法が提供されている。
* https://docs.mapbox.com/help/troubleshooting/mapbox-gl-js-performance/
* https://docs.mapbox.com/help/troubleshooting/working-with-large-geojson-data/

その中から、style.jsonの記述に関するものをまとめてみた。
* 条件分岐は、specificなもの（絞り込みの大きいもの）から記述する。2つ目以降の条件にかける地物数が減るから。
* styleのレイヤを分けるよりも、data-drivenを選択したほうが良い。
* そもそも属性を持っていない場合、エラーが出て遅くなるので`"has"`によるチェックを入れた方が良い。
* `icon-allow-overlap`をFALSEにした方が、描画が速い。

## 縦書き
text-writing-modeを利用すると、縦書きに対応できる。
* text-letter-spacingは縦書きにも効く。
* 長符「ー」が横書きのまま表示される。これは、mapbox-gl.js内の横書き用文字→縦書き用文字の変換リストにないため。試しに、`"ー":"｜",` を追加してテストしてみたらうまくいった。
* データドリブンな表現はできないので、データの属性値に応じて、縦横の指定を行うのはできない。その代わり、縦書きか横書きかの優先度を指定する。
* text-variable-anchor等と合わせて、なるべく多くの注記を表示するという運用を想定しているのかもしれない。
* データドリブンな表現については、データの属性値に応じて、"filter"を用いて縦書き用スタイルレイヤと横書き用スタイルレイヤに分割する方法が考えられる。

## ポリゴンの外周線
ポリゴンの外周線を自由度高く表示するには、ポリゴンとは別にラインとしてレイヤを設定するのがベストなのかもしれない。
* ポリゴン（"type"に"fill"を指定）の外周線を表示する場合、"fill-outline-color"を利用するのが一般的のようだ。
  * しかし、"fill-outline-color"では、色の指定しかできないようだ。
  * そのため、線の太さや破線表現ができない。
* ベクトルタイルデータ自体がポリゴンであっても、スタイル上はライン（"type"は"line"を指定）として表示することはできる。
  * ポリゴンの外周線のみがラインとして表示されることになる。
* 実装方法としては、まず、外周線のラインを描画し、その上にポリゴンを描画する。
  * タイル境界等でラインが表示されてしまうが、ポリゴンを描画する（ポリゴンで塗りつぶす）ことで、隠すことができる。
  * 外周線は、ポリゴンからはみ出す形で描画されるので注意。（なお、"line-width"は最終的な希望の太さの2倍にする必要がある。）

## ラインに沿ってテキストを表示させる
* 文字や数字等のテキストをラインデータに沿って表示させる（"symbol-placement"を"line"に設定する）場合、"text-max-angle"を緩めに設定しておくほうが良い。

## 矢印の表現
* 矢印マークの表現を表現する王道の方法はなさそうであるが、いくつか案がある。
* ラインデータの場合
  * 「＞」のような画像（icon-image）を表示したうえで、ラインデータと合わせて実装する。 
    * 実際には、「　＞」のように、空白を入れた画像として、矢印がなるべくラインデータの先端に表示されるように調整する。
    * 矢印用のラインデータの長さがどれも一定ならば、上記の空白と、"icon-size"で微調整を行えば、おおむねラインの先端に「＞」を表示できると思う。
    * "symbol-placement"を"line-center"に設定。
    * "icon-rotate"は効かないが、何らかの値を設定しておかねば、うまく表示されなかったと記憶している。
    * "icon-rotate"が効かない以上、ラインデータの向きは矢印の向きに対して一定である必要がある。
  * 「→」そのものを"icon-image"として表示する。
    * 未検証。
* ポイントデータの場合
  * この場合は、アイコンの向き（"icon-rotate"）とアイコンの大きさ（"icon-size"）をデータドリブンで調整することができるかもしれない。（矢印の羽の大きさもicon-sizeに伴い、変更されてしまうが。）
    * 未検証。

## フォントについて
* "text-font"（layout property）の設定を行わないと、フォントファイルの読み込みがうまくいかないようである。

## 文字列の抽出
* Mapbox GL JS v1.6.0から、`"in"`を使うことで、文字列の中に特定の文字列があるかどうか判別できるようになった。
* [Mapbox Style Specification](https://docs.mapbox.com/mapbox-gl-js/style-spec/expressions/#in)に記載された`needle`と`haystack`は、「乾草の中の針」という英語のフレーズからのようだ。


